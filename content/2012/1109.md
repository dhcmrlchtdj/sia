+++
date = '2012-11-09'
title = '这样就满意了吗'
tags = ['js']
+++

怎么能把问题推给使用者，我不能接受。

最早看的是 John Resig 的 micro-template，短小精干，只能说佩服的五体投地。
那些 replace、split、join 的用法，不知道是怎么想出来的。风格就像是 jquery，
一眼看去很乱，但实现上确实非常巧妙
（没看懂为什么要用 split 和 join 的组合而不是直接用 replace）。
要说问题的话，就两点：
一是使用 join，现在的测试好像都是说直接字符串相加的效率更高；
二是使用 with，严格模式（strict mode）不支持 with 了。

第一点好说，稍稍改动即可。第二点就麻烦了。
比如 doT.js，使用了严格模式。所以在写模板的时候，
变量都必须带一个前缀来确定作用域。
在 underscore.js 的实现也存在相同的问题，要不使用 with 语句，要不加个前缀。

在其他语言，比如 python 里，exec 语句是可以确定作用域的。
但 js 里，不管是 new Function 还是 eval ，都不支持自定义作用域。
with 语句又禁用，所以可以说是无解了吧。
让使用者在写模板时特意为每个变量加前缀，根本不符合我的美学。
解决这个问题，其实就是把添加前缀的任务交给模板函数来实现。
但目前的模板实现大都是基于正则替换的，所以判断哪些部分加前缀就比较麻烦了。
这个应该需要进行词法分析、语法分析吧。

------

这些天看这些模板实现，最大的收获其实是对 js 的作用域有了更深的了解。
之前妄想能不能靠原型链来解决作用域问题，也去好好看了下 bind、apply、call。
但是，可以的话其他人早就干了，对吧……
