+++
date = '2019-04-21'
title = 'ocaml ppx'
tags = ['ocaml']
+++

rust con ä¸Šæœ‰ä¸¤ä¸ªä¸»é¢˜éƒ½æ¶‰åŠäº† rust çš„ procedural macroã€‚
æƒ³èµ·äº† ocaml çš„ ppxï¼Œæƒ³åˆ°äº†ï¼Œé‚£å°±å†™ä¸€å†™ã€‚

---

[deriving](https://github.com/ocaml-ppx/ppx_deriving) æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ª ppx åº“ã€‚
æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œä¼š rust çš„çœ‹ç€åƒ rustï¼Œä¼š haskell çš„çœ‹ç€åƒ haskellã€‚
ï¼ˆå¤§æ¦‚ï¼Œæ²¡æœ‰äººæ˜¯å…ˆä¼š ocaml çš„ ğŸ˜‚

```ocaml
type point3d = float * float * float
[@@deriving show]
```

é‚£ä¹ˆï¼Œè¿™ä¸ª `@@deriving` æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ
å®˜æ–¹æ–‡æ¡£é‡Œåªæœ‰å¯¥å¯¥æ•°è¯­ï¼Œ[Attributes](https://caml.inria.fr/pub/docs/manual-ocaml-4.08/manual035.html)ã€[Extensions](https://caml.inria.fr/pub/docs/manual-ocaml-4.08/manual036.html)ï¼Œè¿™ä¸ªæ–‡æ¡£ï¼Œå¤§æ¦‚æ²¡äººèƒ½çœ‹æ˜ç™½â€¦â€¦
è¿™ç§æ—¶å€™ï¼Œå°±åªèƒ½é ç¤¾åŒºå†™çš„å·¥å…·å’Œæ•™ç¨‹äº†â€¦â€¦

å…¶å® ppx/macro ä¹Ÿè¿˜æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥ ast è¾“å‡º astï¼Œå†™ä¹‹å‰å…ˆæƒ³æ˜ç™½è¦åšä»€ä¹ˆå°±å¯ä»¥äº†ã€‚
è°ƒè¯•çš„è¯ï¼Œæœ€ç²—æš´çš„å°±æ˜¯æ‰“å°çœ‹ä¸‹æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œä¸è¿‡å¥½åƒä¹Ÿæ²¡æœ‰ä¸ç²—æš´çš„æ–¹æ³•ï¼Ÿ
æ¯”å¦‚å‰é¢çš„ä¾‹å­ï¼Œè¾“å‡ºçš„ä»£ç æ˜¯è¿™æ ·çš„

```ocaml
(* ocamlfind ocamlc -dsource -linkpkg -package ppx_deriving.std point3d.ml *)
type point3d = float * float * float [@@deriving show]

let rec (pp_point3d : Format.formatter -> point3d -> Ppx_deriving_runtime.unit)
    =
    (let open! Ppx_deriving_runtime in
     fun fmt (a0, a1, a2) ->
         Format.fprintf fmt "(@[";
         (Format.fprintf fmt "%F") a0;
         Format.fprintf fmt ",@ ";
         (Format.fprintf fmt "%F") a1;
         Format.fprintf fmt ",@ ";
         (Format.fprintf fmt "%F") a2;
         Format.fprintf fmt "@])") [@ocaml.warning "-A"]


and show_point3d : point3d -> Ppx_deriving_runtime.string =
    fun x -> Format.asprintf "%a" pp_point3d x
```

---

å­¦ ppx å…¥é—¨ä¾‹å­æ˜¯ `ppx_getenv`ï¼Œä» [ç¡¬æ€¼ AST](https://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/) åˆ° [ç¤¾åŒºæ²‰æ·€äº†ä¸€äº›å·¥å…·](http://rgrinberg.com/posts/extension-points-3-years-later/) ï¼Œå†åˆ°å·¥å…·æ•´åˆæˆ [ppxlib](https://github.com/ocaml-ppx/ppxlib/blob/master/HISTORY.md)ã€‚
`ppx_getenv` ä¼šå°† `let user = [%getenv "USER"]` æ”¹å†™æˆ `let user = Some("h11")`ï¼Œåœ¨ç¼–è¯‘æ—¶è®¡ç®—äº† `Sys.getenv_opt "USER"`ã€‚

```ocaml
open Ppxlib
module Ast_builder = Ppxlib.Ast_builder.Default
module Ast_pattern = Ppxlib.Ast_pattern
module Extension = Ppxlib.Extension
module Driver = Ppxlib.Driver

let name = "getenv"

let expander ~loc ~path:_ (env : string) =
    match Sys.getenv_opt env with
        | None ->
            [%expr None]
        | Some s ->
            (* https://github.com/ocaml-ppx/ppxlib/blob/0.6.0/src/ast_builder_intf.ml#L7 *)
            let es = Ast_builder.estring ~loc s in
            [%expr Some [%e es]]

let ext =
    let context = Extension.Context.expression in
    let pattern = Ast_pattern.(single_expr_payload (estring __)) in
    (* https://github.com/ocaml-ppx/ppxlib/blob/0.6.0/src/extension.mli *)
    Extension.declare name context pattern expander

let () = Driver.register_transformation name ~extensions:[ext]

(* https://github.com/ocaml-ppx/ppxlib/blob/0.6.0/src/driver.mli#L167 *)
let () = Driver.run_as_ppx_rewriter ()
```

ä¸Šé¢è¿™ä¸ªä»£ç è¿˜ç®—å¥½ç†è§£ï¼Œå°±æ˜¯ API æ–‡æ¡£ç¼ºå¤±ï¼Œè‡ªå·±ç¿»ä»£ç å§â€¦â€¦
ä¹‹åæŠŠ ppx ç¼–è¯‘å¥½å°±èƒ½ä½¿ç”¨äº†

```
$ ocamlfind ocamlc getenv.ml -package ppxlib -package ppxlib.metaquot -linkpkg -o getenv.ppx
$ ocamlc get-user-example.ml -ppx './getenv.ppx' -dsource
```

è‡³äºæ€ä¹ˆåŒ¹é…åˆ° `[%getenv "USER"]`ã€æ€ä¹ˆæ‹¿åˆ°çš„ `"USER"`ï¼Œè¿™äº›ç»†èŠ‚éƒ½è¢« ppxlib å¤„ç†äº†ã€‚
expander é‡Œå¯ä»¥å†™äº›ä»€ä¹ˆè¯­å¥ï¼Œå¯ä»¥æŸ¥çœ‹ [metaquot](https://ppxlib.readthedocs.io/en/latest/ppx-for-plugin-authors.html#metaquot)ã€‚

---

å›åˆ°æœ€åˆçš„ä¾‹å­ï¼Œ`deriving_eq` è¦æ€ä¹ˆå®ç°å‘¢ï¼Ÿ
é¦–å…ˆï¼Œè¾“å…¥æ˜¯ç±»å‹ç”³æ˜ï¼Œè¾“å‡ºæ˜¯ `eq_type-name` å‡½æ•°ã€‚
ï¼ˆå¥½äº†å¥½äº†ï¼Œad hoc polymorphism æ²¡æœ‰å°±æ²¡æœ‰äº†ï¼Œä¸è¦å–·äº†ã€‚

å…¶æ¬¡ï¼Œ`deriving_eq` æ˜¯æ”¾åœ¨ç±»å‹ç”³æ˜åé¢ï¼Œæ‰€ä»¥è¦å®ç°çš„æ˜¯ `item-attribute`ã€‚
ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ `item-attribute`ï¼Ÿå®˜æ–¹æ–‡æ¡£ã€‚
ç®€å•è®²ï¼Œ`extension` æ˜¯è¯­æ³•ä¸Šçš„å ä½ç¬¦ï¼Œæ¯”å¦‚å‰é¢ç”¨ `[%getenv "USER"]` ä»£æ›¿ `Some(user)`ï¼Œå°±æ˜¯ `extension` ä»£æ›¿äº† [`expr`](https://caml.inria.fr/pub/docs/manual-ocaml-4.08/expr.html#expr)ã€‚
è€Œ `attribute` ç±»ä¼¼æ³¨è§£ï¼Œä¿®é¥°åŸæœ¬å®Œæ•´çš„è¯­å¥ã€‚`type point3d = float * float * float` æœ¬èº«æ˜¯å®Œæ•´çš„ï¼Œæˆ‘ä»¬åªæ˜¯åŠ ä¸Šæ ‡è¯†ï¼Œæ–¹ä¾¿ä¹‹ååšå±•å¼€ã€‚

é€šè¿‡ `ocamlc -dparsetree point3d.ml` çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¦å¤„ç†çš„æ˜¯ `type_declaration`ã€‚

```ocaml
open Ppxlib
module Ast_pattern = Ppxlib.Ast_pattern
module Attribute = Ppxlib.Attribute
module Driver = Ppxlib.Driver

let name = "deriving_eq"

let k x = x

let attr =
    (* ocamlc -dparsetree point3d.ml *)
    let context = Attribute.Context.type_declaration in
    let pattern = Ast_pattern.__ in
    (* https://github.com/ocaml-ppx/ppxlib/blob/0.6.0/src/attribute.mli#L76 *)
    Attribute.declare name context pattern k

let () = Driver.register_transformation name ???

(* https://github.com/ocaml-ppx/ppxlib/blob/0.6.0/src/driver.mli#L167 *)
let () = Driver.run_as_ppx_rewriter ()
```

å…¶ä»–éƒ¨åˆ†å†™ä¸å‡ºæ¥äº†ï¼Œppxlib æ–‡æ¡£å¤ªå°‘â€¦â€¦
